<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>è‡ªåŠ¨åŒ–æ‰¹å¤„ç†å‹ç¼©å›¾ç‰‡ | çƒˆè™</title>
    <meta name="description" content="è‡ªä¿¡ï¼ŒåšæŒï¼Œæ±‚çœŸ">
    <link rel="icon" href="/assets/img/favicon.ico">
  <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?11ee3eaf406620d405bb85e0f32425c7";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
    <link rel="preload" href="/assets/css/0.styles.79bd1ebd.css" as="style"><link rel="preload" href="/assets/js/app.7674bd58.js" as="script"><link rel="preload" href="/assets/js/2.eb556243.js" as="script"><link rel="preload" href="/assets/js/38.63829417.js" as="script"><link rel="prefetch" href="/assets/js/10.894249b8.js"><link rel="prefetch" href="/assets/js/11.d66935ec.js"><link rel="prefetch" href="/assets/js/12.5f755125.js"><link rel="prefetch" href="/assets/js/13.bed573d6.js"><link rel="prefetch" href="/assets/js/14.9f463800.js"><link rel="prefetch" href="/assets/js/15.26b704ec.js"><link rel="prefetch" href="/assets/js/16.ae1dbd06.js"><link rel="prefetch" href="/assets/js/17.e978fc71.js"><link rel="prefetch" href="/assets/js/18.0f7f5789.js"><link rel="prefetch" href="/assets/js/19.85a102b3.js"><link rel="prefetch" href="/assets/js/20.7ca6016c.js"><link rel="prefetch" href="/assets/js/21.76b7747f.js"><link rel="prefetch" href="/assets/js/22.3567ae00.js"><link rel="prefetch" href="/assets/js/23.96931650.js"><link rel="prefetch" href="/assets/js/24.7580cc54.js"><link rel="prefetch" href="/assets/js/25.c3e7b766.js"><link rel="prefetch" href="/assets/js/26.84f4d741.js"><link rel="prefetch" href="/assets/js/27.fd6d5371.js"><link rel="prefetch" href="/assets/js/28.f9f75451.js"><link rel="prefetch" href="/assets/js/29.c6033094.js"><link rel="prefetch" href="/assets/js/3.77c1e61e.js"><link rel="prefetch" href="/assets/js/30.4bd18fc6.js"><link rel="prefetch" href="/assets/js/31.8c9f1a2d.js"><link rel="prefetch" href="/assets/js/32.1e80ff5a.js"><link rel="prefetch" href="/assets/js/33.7e7a7516.js"><link rel="prefetch" href="/assets/js/34.0d9c89e6.js"><link rel="prefetch" href="/assets/js/35.fd84536c.js"><link rel="prefetch" href="/assets/js/36.2520a473.js"><link rel="prefetch" href="/assets/js/37.917f4aa9.js"><link rel="prefetch" href="/assets/js/39.4a2ed5bb.js"><link rel="prefetch" href="/assets/js/4.7680feff.js"><link rel="prefetch" href="/assets/js/40.b1bac7b6.js"><link rel="prefetch" href="/assets/js/41.441dcf54.js"><link rel="prefetch" href="/assets/js/42.32ab25e6.js"><link rel="prefetch" href="/assets/js/43.14d63310.js"><link rel="prefetch" href="/assets/js/44.205480ea.js"><link rel="prefetch" href="/assets/js/45.409eb40f.js"><link rel="prefetch" href="/assets/js/46.39703ac0.js"><link rel="prefetch" href="/assets/js/47.2de8b8a0.js"><link rel="prefetch" href="/assets/js/48.394bd8e4.js"><link rel="prefetch" href="/assets/js/49.d3762a8a.js"><link rel="prefetch" href="/assets/js/5.362bed7a.js"><link rel="prefetch" href="/assets/js/50.e9d8ee9e.js"><link rel="prefetch" href="/assets/js/51.f9a33ad2.js"><link rel="prefetch" href="/assets/js/52.38bab608.js"><link rel="prefetch" href="/assets/js/53.6486e431.js"><link rel="prefetch" href="/assets/js/54.931b8227.js"><link rel="prefetch" href="/assets/js/55.d7c74225.js"><link rel="prefetch" href="/assets/js/56.aa394b0b.js"><link rel="prefetch" href="/assets/js/57.93625539.js"><link rel="prefetch" href="/assets/js/58.521dea28.js"><link rel="prefetch" href="/assets/js/59.24f233cd.js"><link rel="prefetch" href="/assets/js/6.45d0b66a.js"><link rel="prefetch" href="/assets/js/60.ea659059.js"><link rel="prefetch" href="/assets/js/7.c59a4300.js"><link rel="prefetch" href="/assets/js/8.9ea03e14.js"><link rel="prefetch" href="/assets/js/9.d4a1328d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.79bd1ebd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">çƒˆè™</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://segmentfault.com/u/peichenhu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  æˆ‘çš„æ€å¦
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/Guide.html" class="nav-link">æ—¥ç§¯æœˆç´¯</a></div><div class="nav-item"><a href="https://github.com/pch1024" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://segmentfault.com/u/peichenhu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  æˆ‘çš„æ€å¦
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/Guide.html" class="nav-link">æ—¥ç§¯æœˆç´¯</a></div><div class="nav-item"><a href="https://github.com/pch1024" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Guide.html" class="sidebar-link">Hello World</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä»£ç ç‰‡æ®µ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>å¼€æºé¡¹ç›®</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/å¼€æºé¡¹ç›®/dom-to-pdf.html" class="sidebar-link">HTML å¯¼å‡º PDF</a></li><li><a href="/å¼€æºé¡¹ç›®/echarts-in-react.html" class="sidebar-link">ä¸€ä¸ªç”¨äº React é¡¹ç›®çš„ Echarts ç»„ä»¶</a></li><li><a href="/å¼€æºé¡¹ç›®/fix-image-orientation.html" class="sidebar-link">æ•°ç ç…§ç‰‡æ–¹å‘å‚æ•°ä¿®æ­£</a></li><li><a href="/å¼€æºé¡¹ç›®/tinypng-for-node.html" class="active sidebar-link">è‡ªåŠ¨åŒ–æ‰¹å¤„ç†å‹ç¼©å›¾ç‰‡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/å¼€æºé¡¹ç›®/tinypng-for-node.html#è¿™æ˜¯ä¸ªä»€ä¹ˆä¸œä¸œï¼Ÿ" class="sidebar-link">è¿™æ˜¯ä¸ªä»€ä¹ˆä¸œä¸œï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/å¼€æºé¡¹ç›®/tinypng-for-node.html#ç½‘é¡µç‰ˆ-tinypng-ç¼ºç‚¹" class="sidebar-link">ç½‘é¡µç‰ˆ tinypng ç¼ºç‚¹</a></li><li class="sidebar-sub-header"><a href="/å¼€æºé¡¹ç›®/tinypng-for-node.html#å¦‚ä½•ä½¿ç”¨-node-å®ç°è‡ªåŠ¨åŒ–æ‰¹å¤„ç†å‹ç¼©ï¼Ÿ" class="sidebar-link">å¦‚ä½•ä½¿ç”¨ node å®ç°è‡ªåŠ¨åŒ–æ‰¹å¤„ç†å‹ç¼©ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/å¼€æºé¡¹ç›®/tinypng-for-node.html#è‡ªåŠ¨åŒ–è„šæœ¬" class="sidebar-link">è‡ªåŠ¨åŒ–è„šæœ¬</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>åŸåˆ›æ–‡ç« </span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>é¢è¯•é¢˜</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>è®¾è®¡æ¨¡å¼</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç®—æ³•ç ”ç©¶</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/ä¸ªäººç®€å†.html" class="sidebar-link">ä¸ªäººç®€å†</a></li><li><a href="/é¡¹ç›®æ¡ˆä¾‹/é¡¹ç›®æ¡ˆä¾‹.html" class="sidebar-link">é¡¹ç›®æ¡ˆä¾‹</a></li><li><a href="/Optimization.html" class="sidebar-link">ç½‘ç«™ä¼˜åŒ–</a></li><li><a href="/WXAPP.html" class="sidebar-link">å¾®ä¿¡å°ç¨‹åº</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="è‡ªåŠ¨åŒ–æ‰¹å¤„ç†å‹ç¼©å›¾ç‰‡"><a href="#è‡ªåŠ¨åŒ–æ‰¹å¤„ç†å‹ç¼©å›¾ç‰‡" aria-hidden="true" class="header-anchor">#</a> è‡ªåŠ¨åŒ–æ‰¹å¤„ç†å‹ç¼©å›¾ç‰‡</h1> <h2 id="è¿™æ˜¯ä¸ªä»€ä¹ˆä¸œä¸œï¼Ÿ"><a href="#è¿™æ˜¯ä¸ªä»€ä¹ˆä¸œä¸œï¼Ÿ" aria-hidden="true" class="header-anchor">#</a> è¿™æ˜¯ä¸ªä»€ä¹ˆä¸œä¸œï¼Ÿ</h2> <p>æˆ‘ä¸€ç›´æ¯”è¾ƒå–œæ¬¢ä½¿ç”¨ <a href="https://tinypng.com/" target="_blank" rel="noopener noreferrer">tinypng<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> å‹ç¼©å›¾ç‰‡ï¼Œä½†æ˜¯å…è´¹ç‰ˆçš„å­˜åœ¨å¾ˆå¤šé™åˆ¶ï¼Œå¹¶ä¸”è¦ç”¨æ‰‹æ‹–æ¥æ‹–å»ï¼Œç´¯ğŸµã€‚</p> <h2 id="ç½‘é¡µç‰ˆ-tinypng-ç¼ºç‚¹"><a href="#ç½‘é¡µç‰ˆ-tinypng-ç¼ºç‚¹" aria-hidden="true" class="header-anchor">#</a> ç½‘é¡µç‰ˆ <a href="https://tinypng.com/" target="_blank" rel="noopener noreferrer">tinypng<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ç¼ºç‚¹</h2> <ul><li>ä¸€æ¬¡æœ€å¤šå‹ç¼©20ä¸ªå›¾</li> <li>ä¸€ä¸ªå›¾æœ€å¤§ä¸èƒ½è¶…è¿‡ 5MB</li> <li>è¦ç”¨æ‰‹æ‹–æ¥æ‹–å»</li></ul> <h2 id="å¦‚ä½•ä½¿ç”¨-node-å®ç°è‡ªåŠ¨åŒ–æ‰¹å¤„ç†å‹ç¼©ï¼Ÿ"><a href="#å¦‚ä½•ä½¿ç”¨-node-å®ç°è‡ªåŠ¨åŒ–æ‰¹å¤„ç†å‹ç¼©ï¼Ÿ" aria-hidden="true" class="header-anchor">#</a> å¦‚ä½•ä½¿ç”¨ node å®ç°è‡ªåŠ¨åŒ–æ‰¹å¤„ç†å‹ç¼©ï¼Ÿ</h2> <ul><li>é€’å½’è·å–æœ¬åœ°æ–‡ä»¶å¤¹é‡Œçš„æ–‡ä»¶</li> <li>è¿‡æ»¤æ–‡ä»¶ï¼Œåç¼€åæ ¼å¼å¿…é¡»æ˜¯ <code>.jpg</code>ã€ <code>.png</code>ã€<code>å¤§å°å°äº5MB</code>.(æ–‡ä»¶ä½“ç§¯å¤§å°é™åˆ¶ç»•ä¸è¿‡å» - -ã€)</li> <li>å°è£… tinypng API ï¼Œä¼ªè£…è¯·æ±‚ä¸ºæµè§ˆå™¨è¯·æ±‚</li> <li>æ¯æ¬¡å¼‚æ­¥å¤„ç†ä¸€ä¸ªæ–‡ä»¶ï¼ˆæ‰¹å¤„ç†ï¼Œä¸€ä¸ªä¸€ä¸ªä¹Ÿå¾ˆå¿«ï¼Œå¯ä»¥ç»•è¿‡20ä¸ªçš„æ•°é‡é™åˆ¶ï¼‰</li> <li>å¤„ç†è¿”å›æ•°æ®ï¼Œæ‹¿åˆ° tinypng å‹ç¼©å¥½çš„å›¾ç‰‡åœ°å€</li> <li>å–å›è¿œç¨‹å›¾ç‰‡ï¼Œåœ¨å›¾ç‰‡åŸç›®å½•ç”Ÿæˆæ–°å›¾ç‰‡ï¼Œå‘½åæ ¼å¼ä¸ºï¼š<code>åŸåç§°.min.åŸæ ¼å¼</code></li> <li>çº¯nodeå®ç°ï¼ŒçŸ­å°ç²¾æ‚ï¼Œä¸ä¾èµ–ä»»ä½•å…¶ä»–ä»£ç ç‰‡æ®µ</li> <li>å°†è„šæœ¬æ”¾å…¥æœ¬åœ°æ–‡ä»¶å¤¹ï¼Œç›´æ¥æ‰§è¡Œ</li></ul> <h2 id="è‡ªåŠ¨åŒ–è„šæœ¬"><a href="#è‡ªåŠ¨åŒ–è„šæœ¬" aria-hidden="true" class="header-anchor">#</a> è‡ªåŠ¨åŒ–è„šæœ¬</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">URL</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å›¾ç‰‡å­˜æ”¾æ–‡ä»¶å¤¹</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token string">'./'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> exts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'.jpg'</span><span class="token punctuation">,</span> <span class="token string">'.png'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> max <span class="token operator">=</span> <span class="token number">5200000</span><span class="token punctuation">;</span> <span class="token comment">// 5MB == 5242848.754299136</span>

<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  hostname<span class="token punctuation">:</span> <span class="token string">'tinypng.com'</span><span class="token punctuation">,</span>
  path<span class="token punctuation">:</span> <span class="token string">'/web/shrink'</span><span class="token punctuation">,</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rejectUnauthorized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string">'Postman-Token'</span><span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'Cache-Control'</span><span class="token punctuation">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span>
    <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span>
      <span class="token string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">fileList</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è·å–æ–‡ä»¶åˆ—è¡¨</span>
<span class="token keyword">function</span> <span class="token function">fileList</span><span class="token punctuation">(</span><span class="token parameter">folder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>folder<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fileFilter</span><span class="token punctuation">(</span>folder <span class="token operator">+</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¿‡æ»¤æ–‡ä»¶æ ¼å¼ï¼Œè¿”å›æ‰€æœ‰jpg,pngå›¾ç‰‡</span>
<span class="token keyword">function</span> <span class="token function">fileFilter</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      
    <span class="token comment">// æœªçŸ¥é”™è¯¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// å¦‚æœæ˜¯æ–‡ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token comment">// å¿…é¡»æ˜¯æ–‡ä»¶ï¼Œå°äº5MBï¼Œåç¼€ jpg||png</span>
      stats<span class="token punctuation">.</span>size <span class="token operator">&lt;=</span> max <span class="token operator">&amp;&amp;</span>
      stats<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      exts<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ‰¾åˆ°ä¸€ä¸ªéœ€è¦å‹ç¼©çš„å›¾ç‰‡</span>
      <span class="token function">fileUpload</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">// console.log('å¯ä»¥å‹ç¼©ï¼š' + file);</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// å¦‚æœæ˜¯æ–‡ä»¶å¤¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">fileList</span><span class="token punctuation">(</span>file <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å¼‚æ­¥API,å‹ç¼©å›¾ç‰‡</span>

<span class="token comment">/*

 // å¤±è´¥è¿”å›å€¼
 {&quot;error&quot;:&quot;Bad request&quot;,&quot;message&quot;:&quot;Request is invalid&quot;}
 
 // æˆåŠŸè¿”å›å€¼
 {
    &quot;input&quot;:  { &quot;size&quot;: 887, &quot;type&quot;: &quot;image/png&quot; },
    &quot;output&quot;: { 
          &quot;size&quot;: 785,
          &quot;type&quot;: &quot;image/png&quot;, 
          &quot;width&quot;: 81, 
          &quot;height&quot;: 81,
          &quot;ratio&quot;: 0.885, 
          &quot;url&quot;: &quot;https://tinypng.com/web/output/7aztz90nq5p9545zch8gjzqg5ubdatd6&quot; 
     }
 }
*/</span>

<span class="token keyword">function</span> <span class="token function">fileUpload</span><span class="token punctuation">(</span><span class="token parameter">img</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºè¯·æ±‚</span>
  <span class="token keyword">var</span> req <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">buf</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>error<span class="token punctuation">)</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>img<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]ï¼šå‹ç¼©å¤±è´¥ï¼æŠ¥é”™ï¼š</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>obj<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span>  <span class="token function">fileUpdate</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ‰§è¡Œè¯·æ±‚ï¼ˆçœç•¥é‡å‘½åï¼Œç›´æ¥è¦†ç›–ï¼‰</span>
  req<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'binary'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// å‘ç”Ÿé”™è¯¯</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span>  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ–­å¼€è¯·æ±‚</span>
  req<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¯¥æ–¹æ³•è¢«å¾ªç¯è°ƒç”¨,è¯·æ±‚å›¾ç‰‡æ•°æ®</span>
<span class="token keyword">function</span> <span class="token function">fileUpdate</span><span class="token punctuation">(</span><span class="token parameter">imgpath<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
  <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>output<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">let</span> req <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    
    res<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'binary'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      body <span class="token operator">+=</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
      fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>imgpath<span class="token punctuation">,</span> body<span class="token punctuation">,</span> <span class="token string">'binary'</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>imgpath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] \n å‹ç¼©æˆåŠŸï¼ŒåŸå§‹å¤§å°-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>obj<span class="token punctuation">.</span>input<span class="token punctuation">.</span>size<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ï¼Œå‹ç¼©å¤§å°-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
            obj<span class="token punctuation">.</span>output<span class="token punctuation">.</span>size
          <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ï¼Œä¼˜åŒ–æ¯”ä¾‹-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>obj<span class="token punctuation">.</span>output<span class="token punctuation">.</span>ratio<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  req<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/å¼€æºé¡¹ç›®/fix-image-orientation.html" class="prev">æ•°ç ç…§ç‰‡æ–¹å‘å‚æ•°ä¿®æ­£</a></span> <span class="next"><a href="/åŸåˆ›æ–‡ç« /JS-newæ“ä½œæ„é€ å‡½æ•°æ·±åº¦è§£æ.html">JS-newæ“ä½œæ„é€ å‡½æ•°æ·±åº¦è§£æ</a>â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7674bd58.js" defer></script><script src="/assets/js/2.eb556243.js" defer></script><script src="/assets/js/38.63829417.js" defer></script>
  </body>
</html>
